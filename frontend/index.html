<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ü—Ä–æ–∫–∞—Ç –ê–≤—Ç–æ</title>
    <style>
        :root {
            --bg-dark: #111315;
            --sidebar-bg: #1a1d21;
            --content-bg: #111315;
            --card-bg: #1a1d21;
            --text-primary: #ffffff;
            --text-secondary: #8b929a;
            --accent-blue: #2196f3;
            --accent-hover: #1e88e5;
            --border-color: #2c3036;
            --th-bg: #1a1d21;
            --modal-overlay: rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .logo { font-size: 20px; font-weight: 800; margin-bottom: 40px; color: #fff; letter-spacing: 0.5px; }
        .logo span { color: var(--accent-blue); }
        
        .menu-category { font-size: 10px; text-transform: uppercase; color: var(--text-secondary); margin-top: 24px; margin-bottom: 12px; font-weight: 700; letter-spacing: 1px; }
        .menu-item { padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; color: #ccc; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background-color: #2c3036; color: #fff; }
        .menu-item.active { background-color: rgba(33, 150, 243, 0.15); color: var(--accent-blue); }

        /* MAIN CONTENT */
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; background-color: var(--content-bg); }
        .header-row { display: flex; justify-content: space-between; margin-bottom: 24px; align-items: center;}
        h1 { font-size: 24px; font-weight: 700; margin: 0; }

        /* BUTTONS */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-primary:hover { background-color: var(--accent-hover); box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3); }
        
        .action-btn {
            width: 32px; height: 32px; background: #23272b; border: 1px solid #343a40; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s;
            color: #8b929a; margin-left: 6px;
        }
        .action-btn:hover { border-color: #495057; background: #2c3036; }
        .action-btn.view:hover { color: #ffffff; border-color: #fff; } /* New View Button Style */
        .action-btn.edit:hover { color: var(--accent-blue); }
        .action-btn.delete:hover { color: #f44336; }
        .action-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* TABLE */
        .table-wrapper { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background-color: #16191d; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; font-size: 11px; padding: 16px 20px; text-align: left; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); }
        td { padding: 14px 20px; color: #e0e0e0; border-bottom: 1px solid #25282d; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #1f2227; }
        .actions-cell { display: flex; justify-content: flex-end; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); display: none; justify-content: center; align-items: center; z-index: 999; backdrop-filter: blur(2px); }
        .modal { background: #1a1d21; width: 450px; max-width: 90%; border-radius: 12px; padding: 30px; border: 1px solid #343a40; box-shadow: 0 20px 50px rgba(0,0,0,0.6); position: relative; }
        .modal.large { width: 800px; max-height: 80vh; overflow-y: auto; } /* Large modal for details */
        
        .close-modal-btn { position: absolute; top: 20px; right: 20px; width: 30px; height: 30px; background: #23272b; border: 1px solid #343a40; color: #aaa; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; transition: 0.2s; }
        .close-modal-btn:hover { color: #fff; background: #2c3036; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 25px; color: #fff; }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.5px; }
        .form-input { width: 100%; background: #111315; border: 1px solid #2c3036; color: #fff; padding: 12px; border-radius: 6px; box-sizing: border-box; font-size: 13px; outline: none; transition: border-color 0.2s; }
        .form-input:focus { border-color: var(--accent-blue); }

        /* RELATIONS CARDS */
        .relations-container { display: flex; flex-direction: column; gap: 20px; }
        .relation-section-title { font-size: 12px; text-transform: uppercase; color: var(--accent-blue); font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .relation-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .relation-card { background: #111315; border: 1px solid #2c3036; padding: 15px; border-radius: 8px; font-size: 12px; }
        .relation-card div { margin-bottom: 4px; color: #ccc; }
        .relation-card strong { color: #fff; }

        /* STATUS BADGES */
        .badge { padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .badge-green { background: rgba(76, 175, 80, 0.15); color: #66bb6a; }
        .badge-blue { background: rgba(33, 150, 243, 0.15); color: #42a5f5; }
        .badge-red { background: rgba(244, 67, 54, 0.15); color: #ef5350; }
        .badge-gray { background: #2c3036; color: #8b929a; }
        .id-cell { color: #555; font-family: monospace; font-size: 11px;}

                /* –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ */
        .badge-yellow { background: rgba(255, 193, 7, 0.15); color: #ffc107; }   /* –í –æ—Ç–ø—É—Å–∫–µ */
        .badge-purple { background: rgba(156, 39, 176, 0.15); color: #ab47bc; } /* –í –¥–µ–∫—Ä–µ—Ç–µ */
        .badge-cyan { background: rgba(0, 188, 212, 0.15); color: #26c6da; }    /* –ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º */

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="logo">–ê–í–¢–û<span>–ü–†–û–ö–ê–¢</span></div>
        <div class="menu-category">–ê–≤—Ç–æ–ø–∞—Ä–∫</div>
        <div class="menu-item active" onclick="loadPage('vehicles', '–ê–≤—Ç–æ–º–æ–±–∏–ª–∏')">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
        <div class="menu-item" onclick="loadPage('models', '–ú–æ–¥–µ–ª–∏ –∞–≤—Ç–æ')">üìö –ú–æ–¥–µ–ª–∏</div>
        <div class="menu-item" onclick="loadPage('maintenance', '–¢–û –∏ –†–µ–º–æ–Ω—Ç')">üîß –†–µ–º–æ–Ω—Ç—ã</div>
        <div class="menu-item" onclick="loadPage('insurance', '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞')">üõ°Ô∏è –ü–æ–ª–∏—Å—ã</div>
        <div class="menu-category">CRM –∏ –ó–∞–∫–∞–∑—ã</div>
        <div class="menu-item" onclick="loadPage('clients', '–ö–ª–∏–µ–Ω—Ç—ã')">üë• –ö–ª–∏–µ–Ω—Ç—ã</div>
        <div class="menu-item" onclick="loadPage('orders', '–ó–∞–∫–∞–∑—ã')">üìù –ó–∞–∫–∞–∑—ã</div>
        <div class="menu-item" onclick="loadPage('reviews', '–û—Ç–∑—ã–≤—ã')">‚≠ê –û—Ç–∑—ã–≤—ã</div>
        <div class="menu-category">–§–∏–Ω–∞–Ω—Å—ã –∏ –ö–∞–¥—Ä—ã</div>
        <div class="menu-item" onclick="loadPage('payments', '–ü–ª–∞—Ç–µ–∂–∏')">üí∞ –ü–ª–∞—Ç–µ–∂–∏</div>
        <div class="menu-item" onclick="loadPage('fines', '–®—Ç—Ä–∞—Ñ—ã')">üëÆ –®—Ç—Ä–∞—Ñ—ã</div>
        <div class="menu-item" onclick="loadPage('employees', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏')">üëî –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="header-row">
            <h1 id="pageTitle">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</h1>
            <button class="btn btn-primary" onclick="openCreateModal()">+ –î–û–ë–ê–í–ò–¢–¨</button>
        </div>
        <div class="table-wrapper">
            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div id="loading" style="margin-top: 20px; text-align: center; color: #555; display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- EDIT/CREATE MODAL -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <button class="close-modal-btn" onclick="closeModal()">‚úï</button>
            <div class="modal-title" id="modalTitle">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</div>
            <div id="modalFormBody"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 25px; gap: 10px;">
                <button class="btn" style="background: #2c3036; color: white;" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- RELATIONS MODAL (NEW) -->
    <div class="modal-overlay" id="relationsModalOverlay">
        <div class="modal large">
            <button class="close-modal-btn" onclick="document.getElementById('relationsModalOverlay').style.display='none'">‚úï</button>
            <div class="modal-title">–°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏</div>
            <div id="relationsBody" class="relations-container">
                <div style="text-align:center; color:#666">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";
        let currentResource = 'vehicles';
        let currentData = [];
        let editId = null;
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        let sortCol = null;      // –¢–µ–∫—É—â–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        let sortAsc = true;      // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (true = A-Z, false = Z-A)

        // ICONS
        const ICON_EYE = `<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        const ICON_EDIT = `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
        const ICON_TRASH = `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;

        const FIELD_NAMES = { 'id': 'ID', 'model_id': 'ID –ú–æ–¥–µ–ª–∏', 'vehicle_id': 'ID –ê–≤—Ç–æ', 'client_id': 'ID –ö–ª–∏–µ–Ω—Ç–∞', 'employee_id': 'ID –°–æ—Ç—Ä.', 'order_id': 'ID –ó–∞–∫–∞–∑–∞', 'brand': '–ú–∞—Ä–∫–∞', 'model_name': '–ú–æ–¥–µ–ª—å', 'car_class': '–ö–ª–∞—Å—Å', 'daily_rate': '–¶–µ–Ω–∞/—Å—É—Ç–∫–∏', 'deposit_amount': '–ó–∞–ª–æ–≥', 'license_plate': '–ì–æ—Å–Ω–æ–º–µ—Ä', 'vin_code': 'VIN –∫–æ–¥', 'color': '–¶–≤–µ—Ç', 'current_mileage': '–ü—Ä–æ–±–µ–≥', 'status': '–°—Ç–∞—Ç—É—Å', 'full_name': '–§–ò–û', 'driver_license_num': '–í/–£', 'passport_data': '–ü–∞—Å–ø–æ—Ä—Ç', 'phone': '–¢–µ–ª–µ—Ñ–æ–Ω', 'birth_date': '–î–∞—Ç–∞ —Ä–æ–∂–¥.', 'rating': '–†–µ–π—Ç–∏–Ω–≥', 'is_blacklisted': '–ß–°', 'position': '–î–æ–ª–∂–Ω–æ—Å—Ç—å', 'start_date': '–ù–∞—á–∞–ª–æ', 'end_date_planned': '–ü–ª–∞–Ω', 'end_date_actual': '–§–∞–∫—Ç', 'total_cost': '–ò—Ç–æ–≥–æ', 'payment_status': '–û–ø–ª–∞—Ç–∞', 'deposit_returned': '–ó–∞–ª–æ–≥ –≤–æ–∑–≤—Ä.', 'order_status': '–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞', 'amount': '–°—É–º–º–∞', 'payment_date': '–î–∞—Ç–∞', 'payment_type': '–¢–∏–ø', 'method': '–°–ø–æ—Å–æ–±', 'violation_type': '–ù–∞—Ä—É—à–µ–Ω–∏–µ', 'is_paid': '–û–ø–ª–∞—á–µ–Ω–æ', 'issue_date': '–î–∞—Ç–∞', 'service_type': '–í–∏–¥ —Ä–∞–±–æ—Ç', 'cost': '–°—Ç–æ–∏–º–æ—Å—Ç—å', 'description': '–û–ø–∏—Å–∞–Ω–∏–µ', 'end_date': '–û–∫–æ–Ω—á–∞–Ω–∏–µ', 'policy_number': '‚Ññ –ü–æ–ª–∏—Å–∞', 'insurance_company': '–°—Ç—Ä–∞—Ö–æ–≤–∞—è', 'car_rating': '–û—Ü. –∞–≤—Ç–æ', 'client_rating': '–û—Ü. –∫–ª–∏–µ–Ω—Ç–∞', 'comment': '–ö–æ–º–º–µ–Ω—Ç' };
        const VAL_TRANS = { 
            'Available': '–î–æ—Å—Ç—É–ø–µ–Ω', 'Rented': '–í –∞—Ä–µ–Ω–¥–µ', 'Maintenance': '–†–µ–º–æ–Ω—Ç', 
            'Business': '–ë–∏–∑–Ω–µ—Å', 'Economy': '–≠–∫–æ–Ω–æ–º', 'Premium': '–ü—Ä–µ–º–∏—É–º', 'SUV': '–í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫',
            'Paid': '–û–ø–ª–∞—á–µ–Ω', 'Unpaid': '–ù–µ –æ–ø–ª–∞—á–µ–Ω', 'Partial': '–ß–∞—Å—Ç–∏—á–Ω–æ', 
            'Open': '–û—Ç–∫—Ä—ã—Ç', 'Closed': '–ó–∞–∫—Ä—ã—Ç', 'Cancelled': '–û—Ç–º–µ–Ω–µ–Ω', 
            'Income': '–ü—Ä–∏—Ö–æ–¥', 'Refund': '–í–æ–∑–≤—Ä–∞—Ç', 'Card': '–ö–∞—Ä—Ç–∞', 'Cash': '–ù–∞–ª–∏—á–Ω—ã–µ',
            'Active': '–†–∞–±–æ—Ç–∞–µ—Ç', 'Fired': '–£–≤–æ–ª–µ–Ω', 'Vacation': '–í –æ—Ç–ø—É—Å–∫–µ', 'Sick': '–ù–∞ –±–æ–ª—å–Ω–∏—á–Ω–æ–º', 'Maternity': '–í –¥–µ–∫—Ä–µ—Ç–µ'
        };

        // RELATIONS CONFIG
        // –ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ê –°–í–Ø–ó–ï–ô (DRILL-DOWN)
        const RELATIONS_MAP = {
            // --- –†–û–î–ò–¢–ï–õ–ò (–°–≤–µ—Ä—Ö—É –≤–Ω–∏–∑) ---
            'vehicles': [
                { type: 'child', resource: 'maintenance', fk: 'vehicle_id', title: '–ò—Å—Ç–æ—Ä–∏—è —Ä–µ–º–æ–Ω—Ç–æ–≤' },
                { type: 'child', resource: 'orders', fk: 'vehicle_id', title: '–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤' },
                { type: 'child', resource: 'insurance', fk: 'vehicle_id', title: '–°—Ç—Ä–∞—Ö–æ–≤—ã–µ –ø–æ–ª–∏—Å—ã' }
            ],
            'models': [ { type: 'child', resource: 'vehicles', fk: 'model_id', title: '–ê–≤—Ç–æ–º–æ–±–∏–ª–∏' } ],
            'clients': [ { type: 'child', resource: 'orders', fk: 'client_id', title: '–ó–∞–∫–∞–∑—ã' } ],
            'employees': [ { type: 'child', resource: 'orders', fk: 'employee_id', title: '–ó–∞–∫–∞–∑—ã' } ],
            'orders': [
                { type: 'child', resource: 'payments', fk: 'order_id', title: '–ü–ª–∞—Ç–µ–∂–∏' },
                { type: 'child', resource: 'fines', fk: 'order_id', title: '–®—Ç—Ä–∞—Ñ—ã' },
                { type: 'child', resource: 'reviews', fk: 'order_id', title: '–û—Ç–∑—ã–≤—ã' },
                { type: 'parent', resource: 'vehicles', local_fk: 'vehicle_id', title: '–ê–≤—Ç–æ–º–æ–±–∏–ª—å' },
                { type: 'parent', resource: 'clients', local_fk: 'client_id', title: '–ö–ª–∏–µ–Ω—Ç' }
            ],
            
            // --- –î–ï–¢–ò (–°–Ω–∏–∑—É –≤–≤–µ—Ä—Ö) ---
            'maintenance': [ { type: 'parent', resource: 'vehicles', local_fk: 'vehicle_id', title: '–°–≤—è–∑–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å' } ],
            'insurance':   [ { type: 'parent', resource: 'vehicles', local_fk: 'vehicle_id', title: '–°–≤—è–∑–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å' } ],
            'reviews':     [ { type: 'parent', resource: 'orders', local_fk: 'order_id', title: '–ó–∞–∫–∞–∑' } ],
            'payments':    [ { type: 'parent', resource: 'orders', local_fk: 'order_id', title: '–ó–∞–∫–∞–∑' } ],
            'fines':       [ { type: 'parent', resource: 'orders', local_fk: 'order_id', title: '–ó–∞–∫–∞–∑' } ]
        };




        async function loadPage(resource, title) {
            currentResource = resource;
            sortCol = null; // –°–±—Ä–æ—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.getElementById('pageTitle').innerText = title;
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            fetchData();
        }

        async function fetchData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch(`${API_URL}/${currentResource}/`);
                currentData = await response.json();
                document.getElementById('loading').style.display = 'none';
                renderTable(currentData);
            } catch (err) {
                document.getElementById('loading').innerText = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API";
            }
        }

        // --- –°–û–†–¢–ò–†–û–í–ö–ê ---
        function sortTable(key) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —Ç–æ–π –∂–µ –∫–æ–ª–æ–Ω–∫–µ - –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –∏–Ω–∞—á–µ - –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
            if (sortCol === key) {
                sortAsc = !sortAsc;
            } else {
                sortCol = key;
                sortAsc = true;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º currentData
            currentData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ null
                if (valA === null) valA = "";
                if (valB === null) valB = "";

                // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∏, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return sortAsc ? -1 : 1;
                if (valA > valB) return sortAsc ? 1 : -1;
                return 0;
            });

            renderTable(currentData);
        }

        function formatValue(key, val) {
            if (val === null || val === undefined) return '<span style="color:#444">-</span>';
            if (typeof val === 'string' && val.includes('T')) {
                 const date = new Date(val);
                 if (!isNaN(date.getTime())) return val.replace('T', ' ').substring(0, 16);
            }
            if (['status', 'order_status', 'payment_status', 'payment_type'].includes(key)) {
                let color = 'badge-gray';
                if (['Available', 'Paid', 'Closed', 'Income', 'Active', 'Completed'].includes(val)) color = 'badge-green';
                if (['Rented', 'Partial', 'Open'].includes(val)) color = 'badge-blue';
                if (['Maintenance', 'Unpaid', 'Refund', 'Cancelled', 'Fired'].includes(val)) color = 'badge-red';
                if (val === 'Vacation') color = 'badge-yellow';
                if (val === 'Maternity') color = 'badge-purple';
                if (val === 'Sick') color = 'badge-cyan';

                return `<span class="badge ${color}">${VAL_TRANS[val] || val}</span>`;
            }
            if (VAL_TRANS[val]) return VAL_TRANS[val];
            if (typeof val === 'boolean') return val ? '<span style="color:#4caf50">–î–∞</span>' : '<span style="color:#555">–ù–µ—Ç</span>';
            if (key === 'id' || key.endsWith('_id')) return `<span class="id-cell">${val}</span>`;
            return val;
        }

        function renderTable(data) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = ""; tbody.innerHTML = "";
            if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="100" style="text-align:center; padding: 40px; color: #555">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>`; return; }
            
            const keys = Object.keys(data[0]);
            let headerHTML = "<tr>";
            
            keys.forEach(k => {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                let arrow = "";
                if (sortCol === k) {
                    arrow = sortAsc ? " ‚ñ≤" : " ‚ñº";
                }
                // –î–æ–±–∞–≤–ª—è–µ–º onclick –∏ —Å—Ç–∏–ª—å –∫—É—Ä—Å–æ—Ä–∞
                headerHTML += `<th onclick="sortTable('${k}')" style="cursor:pointer; user-select:none;">
                                ${FIELD_NAMES[k] || k} <span style="font-size:10px; color:#666">${arrow}</span>
                               </th>`;
            });
            
            headerHTML += "<th style='text-align:right'>–î–ï–ô–°–¢–í–ò–Ø</th></tr>";
            thead.innerHTML = headerHTML;

            data.forEach(item => {
                let rowHTML = "<tr>";
                keys.forEach(key => { rowHTML += `<td>${formatValue(key, item[key])}</td>`; });
                
                const hasRelations = RELATIONS_MAP[currentResource];
                const eyeBtn = hasRelations ? `<div class="action-btn view" onclick="openRelationsModal(${item.id})" title="–°–≤—è–∑–∏">${ICON_EYE}</div>` : '';

                rowHTML += `
                    <td class="actions-cell">
                        ${eyeBtn}
                        <div class="action-btn edit" onclick="openEditModal(${item.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">${ICON_EDIT}</div>
                        <div class="action-btn delete" onclick="deleteItem(${item.id})" title="–£–¥–∞–ª–∏—Ç—å">${ICON_TRASH}</div>
                    </td>
                </tr>`;
                tbody.innerHTML += rowHTML;
            });
        }

        // --- RELATIONS MODAL ---
                async function openRelationsModal(id) {
            const modal = document.getElementById('relationsModalOverlay');
            const container = document.getElementById('relationsBody');
            modal.style.display = 'flex';
            container.innerHTML = '<div style="text-align:center; padding:20px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            const relationsConfig = RELATIONS_MAP[currentResource];
            if (!relationsConfig) return;

            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –µ—ë FK –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä vehicle_id)
            const currentItem = currentData.find(x => x.id === id);
            if (!currentItem) { container.innerText = "–û—à–∏–±–∫–∞: –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; return; }

            let htmlContent = "";

            for (const rel of relationsConfig) {
                try {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
                    const response = await fetch(`${API_URL}/${rel.resource}/`);
                    const allExternalItems = await response.json();
                    let relatedItems = [];

                    if (rel.type === 'child') {
                        // –õ–æ–≥–∏–∫–∞ "–î–µ—Ç–∏": –ò—â–µ–º —Ç–∞–º –∑–∞–ø–∏—Å–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö fk == –Ω–∞—à ID
                        relatedItems = allExternalItems.filter(x => x[rel.fk] === id);
                    } else if (rel.type === 'parent') {
                        // –õ–æ–≥–∏–∫–∞ "–†–æ–¥–∏—Ç–µ–ª—å": –ò—â–µ–º —Ç–∞–º –æ–¥–Ω—É –∑–∞–ø–∏—Å—å, —á–µ–π ID == –Ω–∞—à local_fk (–Ω–∞–ø—Ä–∏–º–µ—Ä vehicle_id)
                        const parentId = currentItem[rel.local_fk]; // –ù–∞–ø—Ä–∏–º–µ—Ä, 5
                        if (parentId) {
                            const parentItem = allExternalItems.find(x => x.id === parentId);
                            if (parentItem) relatedItems.push(parentItem);
                        }
                    }

                    if (relatedItems.length > 0) {
                        htmlContent += `<div class="relation-section-title">${rel.title}</div>`;
                        htmlContent += `<div class="relation-cards-grid">`;
                        
                        relatedItems.forEach(item => {
                            let cardContent = "";
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –ø–æ–ª–µ–π, –∫—Ä–æ–º–µ ID
                            let count = 0;
                            Object.keys(item).forEach(k => {
                                if (k !== 'id' && !k.includes('_id') && count < 5) {
                                    let val = formatValue(k, item[k]); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!
                                    // –£–±–∏—Ä–∞–µ–º HTML —Ç–µ–≥–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–µ, –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º
                                    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, –±–µ–π–¥–∂–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
                                    cardContent += `<div style="margin-bottom:4px"><strong style="color:#ccc">${FIELD_NAMES[k]||k}:</strong> ${val}</div>`;
                                    count++;
                                }
                            });
                            htmlContent += `<div class="relation-card">${cardContent}</div>`;
                        });
                        htmlContent += `</div><br>`;
                    }
                } catch (e) { console.error(e); }
            }

            if (htmlContent === "") container.innerHTML = '<div style="text-align:center; padding:20px; color:#666">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</div>';
            else container.innerHTML = htmlContent;
        }


        // --- FORMS & CRUD ---
        const SCHEMA = {
            'vehicles': { 'model_id': 'number', 'license_plate': 'text', 'vin_code': 'text', 'color': 'text', 'current_mileage': 'number', 'status': ['Available', 'Rented', 'Maintenance'] },
            'models': { 'brand': 'text', 'model_name': 'text', 'car_class': 'text', 'daily_rate': 'number', 'deposit_amount': 'number' },
            'clients': { 'full_name': 'text', 'driver_license_num': 'text', 'passport_data': 'text', 'phone': 'text', 'birth_date': 'date', 'rating': 'number', 'is_blacklisted': 'boolean' },
            'orders': { 'client_id': 'number', 'vehicle_id': 'number', 'employee_id': 'number', 'start_date': 'datetime-local', 'end_date_planned': 'datetime-local', 'end_date_actual': 'datetime-local', 'total_cost': 'number', 'payment_status': ['Unpaid', 'Partial', 'Paid'], 'deposit_returned': 'boolean', 'order_status': ['Open', 'Closed', 'Cancelled'] },
            'employees': { 'full_name': 'text', 'position': 'text', 'status': ['Active', 'Fired', 'Vacation', 'Sick', 'Maternity'] },
            'payments': { 'order_id': 'number', 'amount': 'number', 'payment_date': 'datetime-local', 'payment_type': ['Income', 'Refund'], 'method': ['Card', 'Cash'] },
            'fines': { 'order_id': 'number', 'violation_type': 'text', 'amount': 'number', 'is_paid': 'boolean', 'issue_date': 'date' },
            'maintenance': { 'vehicle_id': 'number', 'service_type': 'text', 'cost': 'number', 'start_date': 'date', 'end_date': 'date', 'description': 'text' },
            'insurance': { 'vehicle_id': 'number', 'policy_number': 'text', 'insurance_company': 'text', 'start_date': 'date', 'end_date': 'date', 'cost': 'number' },
            'reviews': { 'order_id': 'number', 'car_rating': 'number', 'client_rating': 'number', 'comment': 'text' }
        };

        function openCreateModal() { editId = null; document.getElementById('modalTitle').innerText = "–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å"; generateForm(null); document.getElementById('modalOverlay').style.display = 'flex'; }
        function openEditModal(id) { editId = id; document.getElementById('modalTitle').innerText = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ #${id}`; const item = currentData.find(x => x.id === id); generateForm(item); document.getElementById('modalOverlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

        function generateForm(data) {
            const fields = SCHEMA[currentResource];
            const container = document.getElementById('modalFormBody');
            container.innerHTML = "";
            if (!fields) return;
            Object.keys(fields).forEach(key => {
                const type = fields[key];
                const val = data ? data[key] : '';
                const label = FIELD_NAMES[key] || key;
                let inputHTML = "";
                if (Array.isArray(type)) {
                    let options = type.map(opt => `<option value="${opt}" ${val === opt ? 'selected' : ''}>${VAL_TRANS[opt] || opt}</option>`).join('');
                    inputHTML = `<select class="form-input" id="input_${key}">${options}</select>`;
                } else if (type === 'boolean') {
                    inputHTML = `<select class="form-input" id="input_${key}"><option value="false" ${val === false ? 'selected' : ''}>–ù–µ—Ç</option><option value="true" ${val === true ? 'selected' : ''}>–î–∞</option></select>`;
                } else {
                    let displayVal = val;
                    if(type === 'datetime-local' && val && typeof val === 'string') displayVal = val.slice(0,16);
                    inputHTML = `<input type="${type}" class="form-input" id="input_${key}" value="${displayVal || ''}">`;
                }
                container.innerHTML += `<div class="form-group"><label class="form-label">${label}</label>${inputHTML}</div>`;
            });
        }

        async function saveItem() {
            const fields = SCHEMA[currentResource];
            const payload = {};
            Object.keys(fields).forEach(key => {
                const el = document.getElementById(`input_${key}`);
                let val = el.value;
                if (fields[key] === 'boolean') val = (val === 'true');
                if (fields[key] === 'number') val = Number(val);
                payload[key] = val;
            });
            const method = editId ? 'PUT' : 'POST';
            const url = editId ? `${API_URL}/${currentResource}/${editId}` : `${API_URL}/${currentResource}/`;
            try { await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); closeModal(); fetchData(); } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); }
        }

        async function deleteItem(id) {
            if(!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;
            
            try {
                const response = await fetch(`${API_URL}/${currentResource}/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    // –£—Å–ø–µ—Ö
                    fetchData(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                } else {
                    // –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 400 Bad Request)
                    const errorData = await response.json();
                    // FastAPI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –≤ –ø–æ–ª–µ "detail"
                    const errorMessage = errorData.detail || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
                    alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:\n" + errorMessage);
                }
            } catch (e) {
                // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ç.–¥.)
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.");
            }
        }

    </script>
</body>
</html>
